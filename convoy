#!/bin/bash
# ============================================
#   Convoy Panel Auto Installer
#   Made with ❤️ by Inkbyte Studios
#   Works on: Ubuntu 20.04/22.04, Debian 11/12
# ============================================

set -e

# Colors
RED="\033[0;31m"
GREEN="\033[0;32m"
CYAN="\033[0;36m"
YELLOW="\033[1;33m"
NC="\033[0m" # No Color

clear
echo -e "${CYAN}"
echo "======================================="
echo "        Convoy Panel Installer"
echo "======================================="
echo -e "${NC}"

# Update system
echo -e "${YELLOW}[1/7] Updating system...${NC}"
apt update && apt upgrade -y

# Install Docker
echo -e "${YELLOW}[2/7] Installing Docker...${NC}"
curl -fsSL https://get.docker.com/ | sh

# Install dependencies
echo -e "${YELLOW}[3/7] Installing dependencies...${NC}"
apt install -y docker-compose curl unzip git nano

# Setup directory
echo -e "${YELLOW}[4/7] Setting up Convoy directory...${NC}"
mkdir -p /var/www/convoy
cd /var/www/convoy

# Download Convoy
echo -e "${YELLOW}[5/7] Downloading Convoy Panel...${NC}"
curl -Lo panel.tar.gz https://github.com/convoypanel/panel/releases/latest/download/panel.tar.gz
tar -xzvf panel.tar.gz >/dev/null 2>&1
rm panel.tar.gz

# Permissions
echo -e "${YELLOW}[6/7] Fixing permissions...${NC}"
chmod -R o+w storage/ bootstrap/cache/

# Environment file
cp .env.example .env

echo -e "${GREEN}"
echo "======================================="
echo " Convoy Panel has been downloaded!"
echo "======================================="
echo -e "${NC}"

echo -e "${CYAN}Next Steps:${NC}"
echo "  1. Edit your .env file:"
echo "     nano /var/www/convoy/.env"
echo ""
echo "  2. Start Convoy services:"
echo "     docker compose up -d"
echo ""
echo "  3. Run initial setup:"
echo "     docker compose exec workspace composer install --no-dev --optimize-autoloader"
echo "     docker compose exec workspace php artisan key:generate --force"
echo "     docker compose exec workspace php artisan migrate --force"
echo "     docker compose exec workspace php artisan optimize"
echo "     docker compose exec workspace php artisan c:user:make"
echo ""
echo -e "${GREEN}Installation complete! 🚀${NC}"
